```{r}
#| label: Setup
#| include: false

library(here)

source(here("R", "_setup.R"))
```

<!-- badges: start -->
[![Project Status: Active – The project has reached a stable, usable state and is being actively developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![OSF DOI](https://img.shields.io/badge/OSF-10.17605/OSF.IO/UCMS6-1284C5.svg)](https://doi.org/10.17605/OSF.IO/UCMS6)
[![License: GPLv3](https://img.shields.io/badge/license-GPLv3-bd0000.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![License: CC BY-NC-SA 4.0](https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)
<!-- badges: end -->

## Overview

This report provides a reproducible pipeline for processing [DATASUS](https://datasus.saude.gov.br/) annual population estimates by municipality, age, and sex in Brazil.

For instructions on how to run the pipeline, see the repository [README](https://github.com/sustentarea/population-estimates/blob/main/README.md).

## Problem

Accurate population estimates are fundamental for public health planning, resource allocation, and demographic research. The Department of Informatics of the Brazilian Unified Health System ([DATASUS](https://datasus.saude.gov.br/)) publishes annual population estimates by municipality, age, and sex for Brazil. While these datasets are comprehensive, they require some processing to be directly usable for analysis in R. This pipeline provides a reproducible workflow to download and structure the data, enabling efficient and reliable downstream analyses.

## Data Availability

::: {style="text-align: left;"}
[![](https://img.shields.io/badge/OSF-10.17605/OSF.IO/UCMS6-1284C5.svg)](https://doi.org/10.17605/OSF.IO/UCMS6)
:::

The processed data are available in [`csv`](https://en.wikipedia.org/wiki/Comma-separated_values), [`rds`](https://rdrr.io/r/base/readRDS.html), and [`parquet`](https://en.wikipedia.org/wiki/Apache_Parquet) formats via a dedicated repository on the Open Science Framework ([OSF](https://osf.io)), accessible [here](https://doi.org/10.17605/OSF.IO/UCMS6). Each dataset is accompanied by a metadata file describing its structure and contents.

You can also retrieve these files directly from [R](https://www.r-project.org/) using the [`osfr`](https://docs.ropensci.org/osfr/) package.

## Methods

### Source of Data

The data used in this report come from the following sources:

- Department of Informatics of the Brazilian Unified Health System ([DATASUS](https://datasus.saude.gov.br/)):
  - Annual population estimates by municipality, age, and sex for Brazil [@datasusb], the primary dataset for this pipeline.

### Data Munging

The data munging follow the data science workflow outlined by @wickham2023e, as illustrated in [@fig-wickham-at-al-2023-figure-1]. All processes were made using the [Quarto](https://quarto.org/) publishing system [@allaire], the [R](https://www.r-project.org/) programming language [@rcoreteama] and several R packages.

For data manipulation and workflow, priority was given to packages from the [tidyverse](https://www.tidyverse.org/), [rOpenSci](https://ropensci.org/) and [r-spatial](https://r-spatial.org/) ecosystems, as well as other packages adhering to the tidy tools manifesto [@wickham2023c].

::: {#fig-wickham-at-al-2023-figure-1}
![](images/wickham-at-al-2023-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Data science workflow created by Wickham, Çetinkaya-Runde, and Grolemund.
:::

### Code Style

The Tidyverse [Tidy Tools Manifesto](https://tidyverse.tidyverse.org/articles/manifesto.html) [@wickham2023c], [code style guide](https://style.tidyverse.org/) [@wickhamb] and [design principles](https://design.tidyverse.org/) [@wickhamc] were followed to ensure consistency and enhance readability.

### Reproducibility

The pipeline is fully reproducible and can be run again at any time. To ensure consistent results, the [`renv`](https://rstudio.github.io/renv/) package [@usheya] is used to manage and restore the R environment. See the [README](https://github.com/cem-usp/locais-nova-rais-geocoding/blob/main/README.md) file in the code repository to learn how to run it.

## Set Environment

### Load Packages

```{r}
#| label: Set the Environment
#| code-fold: false
#| output: false

library(brandr)
library(cli)
library(dplyr)
library(foreign)
library(fs)
library(geobr)
library(ggplot2)
library(ggspatial)
library(here)
library(htmltools)
library(httr2)
library(janitor)
library(labelled)
library(nanoparquet)
library(orbis) # github.com/danielvartan/orbis
library(osfr)
library(readr)
library(sf)
library(stringr)
library(tidyr)
library(zip)
```

### Set Data Directories

```{r}
raw_data_dir <- here("data-raw")
data_dir <- here("data")
```

```{r}
for (i in c(raw_data_dir, data_dir)) {
  if (!dir_exists(i)) dir_create(i, recurse = TRUE)
}
```

### Set Initial Variables

::: {.callout-note}
The `year` variable represent the year of the consolidated [DATASUS](https://datasus.saude.gov.br/) dataset. Click [here](http://tabnet.datasus.gov.br/cgi/deftohtm.exe?ibge/cnv/popsvs2024br.def) to see the available years.
:::

```{r}
year <- 2025
```

## Download Data

::: {.callout-note}
See the [Source of Data](#source-of-data) section for more information.
:::

### Get Data

```{r}
#| label: Download DATASUS Population Estimates Data

file <-
  "POPSBR" |>
  paste0(str_sub(year, 3, 4), ".zip")
```

```{r}
#| eval: true
#| output: false

"ftp.datasus.gov.br" |>
  path(
    "dissemin",
    "publicos",
    "IBGE",
    "POPSVS",
    file
  ) |>
  request() |>
  req_progress() |>
  req_perform(here(raw_data_dir, file))
```

### Unzip Data

```{r}
#| eval: true

here(raw_data_dir, file) |>
  unzip(exdir = raw_data_dir)
```

```{r}
file <-
  raw_data_dir |>
  dir_ls(
    type = "file",
    regexp = paste0(str_sub(year, 3, 4), "\\.dbf$")
  ) |>
  basename()
```

### Delete Zip Files

```{r}
#| eval: true

raw_data_dir |>
  dir_ls(
    type = "file",
    regexp = "\\.zip$"
  ) |>
  file_delete()
```

## Import Data

```{r}
#| label: Import Data

data <-
  raw_data_dir |>
  here(file) |>
  read.dbf() |>
  as_tibble()
```

```{r}
data |> glimpse()
```

## Tidy Data

### Rename Columns

```{r}
#| label: Tidy Data

data <-
  data |>
  clean_names() |>
  rename(
    municipality_code = cod_mun,
    year = ano,
    sex = sexo,
    age = idade,
    population = pop
  )
```

```{r}
data |> glimpse()
```

### Standardize Columns

```{r}
data <-
  data |>
  mutate(
    across(
      .cols = where(is.factor),
      .fns = \(x) x |> as.character() |> as.integer()
    )
  ) |>
  mutate(
    sex = sex |>
      factor(
        levels = 1:2,
        labels = c("male", "female"),
        ordered = FALSE
      )
  )
```

```{r}
data |> glimpse()
```

### Relocate Columns

```{r}
data <- data |> relocate(year)
```

```{r}
data |> glimpse()
```

### Arrange Data

```{r}
data <-
  data |>
  arrange(
    year,
    municipality_code,
    sex,
    age
  )
```

```{r}
data |> glimpse()
```

## Create Data Dictionary

### Prepare Metadata

```{r}
#| label: Create Data Dictionary

metadata <-
  data |>
  `var_label<-`(
    list(
      year = "Year of the population estimate",
      municipality_code = "IBGE municipality code",
      sex = "Sex of the population",
      age = "Age of the population",
      population = "Population estimate"
    )
  ) |>
  generate_dictionary(details = "full") |>
  convert_list_columns_to_character()
```

### Visualize Final Data

```{r}
metadata |> glimpse()
```

```{r}
metadata
```

```{r}
data |> glimpse()
```

```{r}
data
```

## Save Data

::: {.callout-note}
The processed data are available in [`csv`](https://en.wikipedia.org/wiki/Comma-separated_values), [`rds`](https://rdrr.io/r/base/readRDS.html) and [`parquet`](https://en.wikipedia.org/wiki/Apache_Parquet) formats through a dedicated repository on the Open Science Framework ([OSF](https://doi.org/10.17605/OSF.IO/8J94M)). See the [Data Availability](#data-availability) section for more information.
:::

### Write Data

```{r}
#| label: Save Data

valid_file_pattern <- year
```

```{r}
data |>
  write_csv(
    here(data_dir, paste0(valid_file_pattern, ".csv"))
  )
```

```{r}
data |>
  write_rds(
    here(data_dir, paste0(valid_file_pattern, ".rds"))
  )
```

```{r}
data |>
  write_parquet(
    here(data_dir, paste0(valid_file_pattern, ".parquet"))
  )
```

### Write Metadata

```{r}
metadata_file_pattern <-
  "metadata-" |>
  paste0(year)
```

```{r}
metadata |>
  write_csv(
    here(data_dir, paste0(metadata_file_pattern, ".csv"))
  )
```

```{r}
metadata |>
  write_rds(
    here(data_dir, paste0(metadata_file_pattern, ".rds"))
  )
```

```{r}
metadata |>
  write_parquet(
    here(data_dir, paste0(metadata_file_pattern, ".parquet"))
  )
```

<!-- ## Upload the Data to OSF (Optional) -->

<!-- Only repository administrators can upload data to OSF. -->
<!-- To enable uploads, set a `OSF_PAT` environment variable with a valid OSF personal access token. -->

```{r}
#| eval: false
#| include: false

Sys.getenv("OSF_PAT") |> osf_auth()
```

```{r}
#| eval: false
#| include: false

osf_valid_data_id <- "h3pyd"
```

```{r}
#| eval: false
#| include: false

osf_valid_data_id |>
  osf_retrieve_node() |>
  osf_upload(
    path = c(
      here(data_dir, paste0(valid_file_pattern, ".csv")),
      here(data_dir, paste0(valid_file_pattern, ".rds")),
      here(data_dir, paste0(valid_file_pattern, ".parquet")),
      here(data_dir, paste0(metadata_file_pattern, ".csv")),
      here(data_dir, paste0(metadata_file_pattern, ".rds")),
      here(data_dir, paste0(metadata_file_pattern, ".parquet"))
    ),
    conflicts = "overwrite"
  )
```

## Explore Data

### Plot Histogram by Municipality

```{r}
#| label: Explore Data
#| code-fold: true

data |>
  summarize(
    population = sum(population, na.rm = TRUE),
    .by = "municipality_code"
  ) |>
  ggplot(aes(x = population)) +
  geom_histogram(
    aes(y = after_stat(density)),
    bins = 30,
    fill = get_brand_color("gray-d25"),
    color = get_brand_color("white")
  ) +
  geom_density(
    color = "red",
    linewidth = 1
  ) +
  scale_x_continuous(
    transform = "log10"
  ) +
  labs(
    title = "Population Estimates by Municipality in Brazil",
    subtitle = paste0("Year: ", year),
    x = "Population Estimate",
    y = "Density",
    caption = "Source: DATASUS/IBGE."
  )
```

### Plot Map by Municipality

#### Set Shape

```{r}
#| code-fold: true

shape <-
  read_municipality(
    year = year |>
      closest_geobr_year(type = "municipality"),
    showProgress = FALSE
  ) |>
  st_transform(st_crs(4326))
```

#### Prepare Plot Data

```{r}
#| code-fold: true

plot_data <-
  data |>
  summarize(
    population = sum(population, na.rm = TRUE),
    .by = "municipality_code"
  ) |>
  left_join(
    shape,
    by = join_by(municipality_code == code_muni)
  ) |>
  rename(geometry = geom) |>
  select(
    municipality_code,
    population,
    geometry
  ) |>
  drop_na(population)
```

#### Plot Data

```{r}
#| code-fold: true

brand_div_palette <- function(x) {
  brandr:::make_color_ramp(
    n = x,
    colors = c(
      get_brand_color("dark-red"),
      # get_brand_color("white"),
      get_brand_color_mix(
        position = 950,
        color_1 = "dark-red",
        color_2 = "dark-red-triadic-blue",
        alpha = 0.5
      ),
      get_brand_color("dark-red-triadic-blue")
    )
  )
}
```

```{r}
#| code-fold: true

plot_data |>
  st_as_sf() |>
  ggplot(aes(fill = population)) +
  geom_sf(
    color = get_brand_color("gray"),
    linewidth = 0.05
  ) +
  scale_fill_binned(
    palette = brand_div_palette,
    na.value = get_brand_color("gray-d25"),
    transform = "log10"
  ) +
  annotation_scale(
    aes(),
    location = "br",
    style = "tick",
    height = unit(0.5, "lines")
  ) +
  annotation_north_arrow(
    location = "br",
    height = unit(2, "lines"),
    width = unit(2, "lines"),
    pad_x = unit(0.25, "lines"),
    pad_y = unit(1.25, "lines"),
    style = north_arrow_fancy_orienteering
  ) +
  labs(
    title = "Population Estimates by Municipality in Brazil",
    subtitle = paste0("Year: ", year),
    fill = NULL,
    caption = "Source: DATASUS/IBGE."
  )
```

## Citation

::: {.callout-important}
When using this data, you must also cite the original data sources.
:::

To cite this work, please use the following format:

Vartanian, D., & Carvalho, A. M. (2025). *A reproducible pipeline for processing DATASUS annual population estimates by municipality, age, and sex in Brazil* \[Computer software\]. Sustentarea Research and Extension Group, University of São Paulo. <https://sustentarea.github.io/population-estimates>

A BibLaTeX entry for LaTeX users is:

```
@software{vartanian2025,
  title = {A reproducible pipeline for processing DATASUS annual population estimates by municipality, age, and sex in Brazil},
  author = {{Daniel Vartanian} and {Aline Martins de Carvalho}},
  year = {2025},
  address = {São Paulo},
  institution = {Sustentarea Research and Extension Group, the University of São Paulo},
  langid = {en},
  url = {https://sustentarea.github.io/population-estimates}
}
```

## License

[![License: GPLv3](https://img.shields.io/badge/license-GPLv3-bd0000.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![License: CC BY-NC-SA 4.0](https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)

::: {.callout-important}
The original data sources may be subject to their own licensing terms and conditions.
:::

The code in this repository is licensed under the [GNU General Public License Version 3](https://www.gnu.org/licenses/gpl-3.0), while the report is available under the [Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-nc-sa/4.0/).

```
Copyright (C) 2025 Sustentarea Research and Extension Group

The code in this report is free software: you can redistribute it and/or
modify it under the terms of the GNU General Public License as published by the
Free Software Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see <https://www.gnu.org/licenses/>.
```

## Acknowledgments

```{=html}
<br>
```

```{r, results='asis'}
#| echo: false

blocks <- list(
  list(
    logo_link = "https://www.fsp.usp.br/sustentarea/",
    logo_src = "images/sustentarea-icon.svg",
    logo_alt = "Sustentarea Logo",
    logo_width = 100,
    text = 'This work is part of a research project by the <a href="https://www.fsp.usp.br/sustentarea/">Sustentarea</a> Research and Extension Group of the University of São Paulo (<a href="https://usp.br/">USP</a>) titled: <em>Global syndemic: The impact of anthropogenic climate change on the health and nutrition of children under five years old attended by Brazil\'s public health system</em>.'
  ),
  list(
    logo_link = "https://www.gov.br/cnpq/",
    logo_src = "images/cnpq-logo.svg",
    logo_alt = "CNPq Logo",
    logo_width = 160,
    text = 'This work was supported by the Department of Science and Technology of the Secretariat of Science, Technology, and Innovation and of the Health Economic-Industrial Complex (<a href="https://www.gov.br/saude/pt-br/composicao/sectics/">SECTICS</a>) of the <a href="https://www.gov.br/saude/pt-br/composicao/sectics/">Ministry of Health</a> of Brazil, and the National Council for Scientific and Technological Development (<a href="https://www.gov.br/cnpq/">CNPq</a>) (grant no. 444588/2023-0).'
  )
)

blocks |>
  lapply(
    function(x) {
      div(
        style = paste0(
          "display: flex; ",
          "align-items: flex-start; ",
          "margin-bottom: 2em;"
        ),
        div(
          style = paste0(
            "flex: 0 0 30%; ",
            "display: flex; ",
            "justify-content: center; ",
            "margin: auto 0;"
          ),
          tags$a(
            href = x$logo_link,
            tags$img(
              src = x$logo_src,
              alt = x$logo_alt,
              style = paste0(
                "width: ",
                x$logo_width,
                "px; ",
                "height: auto;"
              )
            )
          )
        ),
        div(
          style = paste0(
            "flex: 1; ",
            "padding-left: 1em;"
          ),
          HTML(x$text)
        )
      )
    }
  ) |>
  tagList() |>
  browsable()
```

## References {.unnumbered}

::: {#refs}
:::
